
name: Build and Deploy
on: [push, pull_request]
jobs:
  build-and-publish-docker-image:
    name: Build and publish docker image
    runs-on: ubuntu-18.04
    env:
      REGISTRY: c.rzp.io
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Login with docker
        run: docker login ${REGISTRY} --username ${{ secrets.HARBOR_DOCKER_USERNAME }} --password ${{ secrets.HARBOR_DOCKER_PASSWORD }}
      - name: Build and Push docker image
        if: success()
        run: |
          docker build -f public.Dockerfile --target=oidc-release -t ${REGISTRY}/razorpay/amundsen-frontend-oidc:${GITHUB_SHA} .
          docker push ${REGISTRY}/razorpay/amundsen-frontend-oidc:${GITHUB_SHA}
      - name: Publish to Registry for latest
        if: success() && github.ref == 'refs/heads/master'
        run: |
          docker build -f public.Dockerfile --target=oidc-release -t ${REGISTRY}/razorpay/amundsen-frontend-oidc:latest .
          docker push ${REGISTRY}/razorpay/amundsen-frontend-oidc:latest
